
# LQR 제어기 작동 원리 설명

이 문서는 `Kalman + LQR` 제어 시스템에서 LQR 컨트롤러의 수식적 동작 원리를 처음 접하는 사람도 이해할 수 있도록 정리한 내용입니다.

---

## ✅ 전체 흐름 요약

시스템은 다음과 같은 **선형 상태 공간 모델**로 표현됩니다:

$$
x_{k+1} = A x_k + B u_k
$$

- $x_k$: 현재 상태 벡터 (위치, 속도 등)
- $u_k$: 제어 입력 벡터 (가속도, 조향각 등)
- $A$: 상태 전이 행렬
- $B$: 입력 행렬

LQR은 $x_k$가 목표 상태 $x_{\text{ref}}$로 수렴하도록 **최적 제어 입력 $u_k$**를 계산합니다.

---

## ✅ 1. 상태 정의

지금 시스템의 상태 벡터 $x$는 다음과 같습니다:

$$
x = \begin{bmatrix} x \\ y \\ \psi \\ v \end{bmatrix}
$$

- $x$: 위치 (X)
- $y$: 위치 (Y)
- $\psi$: 차량 방향 (yaw)
- $v$: 속도

---

## ✅ 2. 제어 입력 정의

제어 입력 $u$는 다음과 같습니다:

$$
u = \begin{bmatrix} a \\ \delta \end{bmatrix}
$$

- $a$: 가속도
- $\delta$: 조향각

---

## ✅ 3. 시스템 행렬 A, B

```python
A = np.eye(4)
A[0, 3] = dt
A[1, 3] = dt
```

$$
A =
\begin{bmatrix}
1 & 0 & 0 & dt \\
0 & 1 & 0 & dt \\
0 & 0 & 1 &  0 \\
0 & 0 & 0 &  1
\end{bmatrix}
$$

```python
B = np.zeros((4, 2))
B[3, 0] = dt
B[2, 1] = dt
```

$$
B =
\begin{bmatrix}
0 & 0 \\
0 & 0 \\
0 & dt \\
dt & 0
\end{bmatrix}
$$

---

## ✅ 4. 비용 함수 (Cost Function)

LQR은 아래의 비용 함수를 최소화하는 제어기를 계산합니다:

$$
J = \int_0^\infty \left( x^\top Q x + u^\top R u \right) dt
$$

- $Q$: 상태 오차에 대한 중요도
- $R$: 제어 입력의 크기에 대한 패널티

---

## ✅ 5. 최적 제어 이득 K 계산

```python
P = solve_continuous_are(A, B, Q, R)
K = np.linalg.inv(R) @ B.T @ P
```

- $K$: 상태 오차에 기반한 제어 입력 계산 이득 행렬

---

## ✅ 6. 제어 입력 계산

$$
u = -K (x - x_{\text{ref}})
$$

즉, 현재 상태가 목표 상태보다 얼마나 벗어났는지를 계산하여 그 오차에 대해 $K$를 곱하여 보정 제어 입력을 생성합니다.

---

## ✅ 예시

```python
x_hat = [5.0, 1.2, 0.1, 2.3]
x_ref = [5.5, 1.0, 0.0, 2.0]
error = x_hat - x_ref
u = -K @ error
# u = [a, δ] 형태의 제어 입력
```

---

## ✅ 한 줄 요약

**LQR은 상태 오차를 최소화하면서, 제어 입력이 너무 커지지 않도록 조절하는 최적 제어기입니다.**
